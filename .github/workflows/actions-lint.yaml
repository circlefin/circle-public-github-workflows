# Copyright 2023 Circle Internet Financial, LTD.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

name: Lint/Validate Github Actions files

on:
  workflow_call:

jobs:
  lint_validate_actions:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: block
          policy: global-allowed-endpoints-policy

      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Checkout Actoinlint Configs
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          repository: circlefin/circle-public-github-workflows
          ref: stable
          path: .actionlint
          sparse-checkout: |-
            config/linters

      - name: Run actionlint
        env:
          ACTIONLINT_DL: https://github.com/rhysd/actionlint/releases/download/v1.6.26/actionlint_1.6.26_linux_amd64.tar.gz
          ACTIONLINT_SHA: f0294c342af98fad4ff917bc32032f28e1b55f76aedf291886ec10bbed7c12e1
        shell: bash
        run: |
          echo "::add-matcher::.actionlint/config/linters/actionlint-matcher.json"
          curl -sSfLo "${RUNNER_TEMP}/actionlint.tar.gz" ${ACTIONLINT_DL}
          sha256sum -c <<< "${ACTIONLINT_SHA} ${RUNNER_TEMP}/actionlint.tar.gz"
          tar xvzf ${RUNNER_TEMP}/actionlint.tar.gz actionlint

          ./actionlint -color -shellcheck="" --config-file .actionlint/config/linters/actionlint.yaml

      - name: json-yaml-validate
        uses: GrantBirki/json-yaml-validate@3a3d883daf915618a7503a2e9c04b8e57130a4b8 # v3.0.0
        with:
          comment: true

      - name: Ensure SHA pinned actions
        uses: step-security/github-actions-ensure-sha-pinned-actions@f7fe3af55c789fc8c2b9b46a34b9e3a32d5dcd6f # v3.0.25
        with:
          allowlist: |
            circlefin/
